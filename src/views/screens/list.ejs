<%- include('../layout/header') %>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gestión de Pantallas</h2>
        <button class="btn btn-cerulean" data-action="create-screen">
            <i class="fa-solid fa-plus"></i> Nueva Pantalla
        </button>
    </div>

    <div class="row">
        <% if (screens.length===0) { %>
            <div class="col-12">
                <div class="alert alert-info text-center">
                    No hay pantallas registradas. ¡Agrega una nueva!
                </div>
            </div>
            <% } %>

                <% screens.forEach(screen=> { %>
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                <h5 class="mb-0 text-truncate" title="<%= screen.name %>">
                                    <%= screen.name %>
                                </h5>
                                <span class="badge bg-<%= screen.is_active ? 'success' : 'secondary' %>">
                                    <%= screen.device_type==='browser' ? 'Navegador' : 'DLNA (TV)' %>
                                </span>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted mb-3">
                                    <i class="fa-solid fa-network-wired me-1"></i>
                                    <%= screen.ip_address || 'Sin IP asignada' %>
                                </p>

                                <% if (screen.device_type==='browser' ) { %>
                                    <!-- Samsung TV Control Panel -->
                                    <div class="card bg-light mb-2 p-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted fw-bold">Control Samsung</small>
                                            <% if (screen.samsung_token) { %>
                                                <i class="bi bi-key-fill text-success" title="Emparejado"></i>
                                                <% } else { %>
                                                    <i class="bi bi-key text-secondary" title="Sin emparejar"></i>
                                                    <% } %>
                                        </div>

                                        <!-- MAC Address Field -->
                                        <% if (!screen.mac_address) { %>
                                            <div class="input-group input-group-sm mb-2">
                                                <input type="text" class="form-control form-control-sm"
                                                    placeholder="MAC: AA:BB:CC:DD:EE:FF" id="mac-input-<%= screen.id %>"
                                                    data-screen-id="<%= screen.id %>">
                                                <button class="btn btn-outline-secondary btn-sm" data-action="save-mac"
                                                    data-id="<%= screen.id %>">
                                                    <i class="bi bi-save"></i>
                                                </button>
                                            </div>
                                            <% } else { %>
                                                <small class="text-muted d-block mb-2">
                                                    <i class="bi bi-hdd-network"></i>
                                                    <%= screen.mac_address %>
                                                </small>
                                                <% } %>

                                    </div>

                                    <%- include('samsung-remote-panel', { screen }) %>

                                        <!-- Rutina de Encendido Automático -->
                                        <% if (screen.mac_address) { %>
                                            <button class="btn btn-success btn-sm w-100 mb-2" data-action="startup"
                                                data-id="<%= screen.id %>"
                                                title="Encender y abrir navegador automáticamente">
                                                <i class="bi bi-rocket-takeoff me-1"></i> Rutina de Encendido
                                            </button>
                                            <% } %>

                                                <!-- Existing Buttons -->
                                                <div class="d-grid gap-2 mb-2">
                                                    <a href="/screens/viewer/<%= screen.id %>" target="_blank"
                                                        class="btn btn-outline-primary btn-sm">
                                                        <i class="fa-solid fa-external-link-alt me-1"></i> Abrir Visor
                                                    </a>
                                                    <button class="btn btn-primary btn-sm" data-action="reload"
                                                        data-id="<%= screen.id %>">
                                                        <i class="fa-solid fa-sync-alt me-1"></i> Recargar Tasa
                                                    </button>
                                                </div>
                                                <% } else if (screen.device_type==='dlna' ) { %>
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted">Seleccionar
                                                            Medio:</label>
                                                        <select id="media-<%= screen.id %>"
                                                            class="form-select form-select-sm mb-2">
                                                            <% if (mediaFiles.length===0) { %>
                                                                <option disabled selected>Sin archivos en public/media
                                                                </option>
                                                                <% } %>
                                                                    <% mediaFiles.forEach(file=> { %>
                                                                        <option
                                                                            value="http://localhost:4000/media/<%= file %>">
                                                                            <%= file %>
                                                                        </option>
                                                                        <% }) %>
                                                        </select>
                                                        <button class="btn btn-success btn-sm w-100 mb-2"
                                                            data-action="play" data-id="<%= screen.id %>"
                                                            data-ip="<%= screen.ip_address %>" <%=!screen.ip_address
                                                            ? 'disabled' : '' %>>
                                                            <i class="fa-solid fa-play me-1"></i> Reproducir
                                                        </button>
                                                    </div>
                                                    <% } %>

                                                        <!-- Botones de Editar y Eliminar -->
                                                        <div class="btn-group w-100" role="group">
                                                            <button class="btn btn-outline-secondary btn-sm"
                                                                data-action="edit" data-id="<%= screen.id %>">
                                                                <i class="fa-solid fa-edit"></i> Editar
                                                            </button>
                                                            <button class="btn btn-outline-danger btn-sm"
                                                                data-action="delete" data-id="<%= screen.id %>"
                                                                data-name="<%= screen.name %>">
                                                                <i class="fa-solid fa-trash"></i> Eliminar
                                                            </button>
                                                        </div>
                            </div>
                        </div>
                    </div>
                    <% }) %>
    </div>

    <!-- Modal Crear/Editar Pantalla -->
    <div class="modal fade" id="modalScreen" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header card-header-cerulean">
                    <h5 class="modal-title text-white" id="modalTitle">Nueva Pantalla</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formScreen">
                        <input type="hidden" id="screenId">

                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="screenName" required
                                placeholder="Ej: TV Recepción">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tipo de Dispositivo *</label>
                            <select class="form-select" id="deviceType">
                                <option value="browser">Navegador (Samsung/PC)</option>
                                <option value="dlna">DLNA (LG/Smart TV)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                Dirección IP
                                <span id="ipRequired" style="display: none;">(Requerido para DLNA)</span>
                            </label>
                            <input type="text" class="form-control" id="ipAddress" placeholder="Ej: 192.168.1.50">
                            <small class="text-muted">Para navegadores, la IP es opcional</small>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" checked>
                                <label class="form-check-label" for="isActive">Activo</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-frosted" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-cerulean" id="btnSave">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../layout/footer') %>